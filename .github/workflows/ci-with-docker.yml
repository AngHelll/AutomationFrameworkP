# ğŸ³ CI/CD Workflow - Docker Approach (FOR PRACTICE & LEARNING)
#
# ğŸ¯ What this does:
#    - Builds Docker image with all dependencies
#    - Runs tests inside containers (isolated!)
#    - Great for learning Docker in CI/CD
#
# â±ï¸  Execution time: ~2-3 minutes (with cache)
# ğŸ’° Cost: HIGHER (longer build time)
# ğŸ“ Recommended for: Learning, production-like testing
#
# ğŸ“Š When it runs:
#    - Every push to main branch
#    - Every pull request to main branch
#    - Manual trigger (workflow_dispatch)
#
# ğŸ’¡ COMPARISON:
#    This runs IN PARALLEL with ci.yml
#    Compare execution times and results!

name: CI with Docker - Practice

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  # ğŸ® Manual trigger - try it yourself!
  # Go to: Actions â†’ CI with Docker â†’ Run workflow
  workflow_dispatch:

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ³ JOB 1: Test with Docker (Container-based)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test-with-docker:
    runs-on: ubuntu-latest
    
    steps:
      # ğŸ“¥ STEP 1: Get the code
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        # Downloads your code to build Docker image

      # ğŸ—ï¸  STEP 2: Setup Docker Buildx
      # Advanced Docker builder with caching support
      - name: ğŸ—ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        # What is Buildx?
        # - Advanced Docker builder
        # - Better caching (faster builds)
        # - Multi-platform support
        # - Required for modern Docker features

      # ğŸ³ STEP 3: Build Docker Image
      # Creates container image with your framework
      - name: ğŸ³ Build Docker Image
        run: |
          docker build -t automation-framework:${{ github.sha }} .
          docker tag automation-framework:${{ github.sha }} automation-framework:latest
        # Command breakdown:
        # 1. docker build              â†’ Create image from Dockerfile
        # 2. -t automation-framework   â†’ Tag/name the image
        # 3. :${{ github.sha }}        â†’ Version tag (unique commit hash)
        # 4. docker tag ... :latest    â†’ Also tag as 'latest'
        #
        # ğŸ” What's in the image:
        # - Python 3.11
        # - Google Chrome (for Selenium)
        # - All pip packages (pytest, selenium, behave, etc.)
        # - Your framework code
        # - All dependencies ready to go!
        #
        # â±ï¸  Build time:
        # - First build: ~2 minutes (installs everything)
        # - Cached build: ~30 seconds (reuses layers)

      # ğŸ§ª STEP 4: Run Pytest Tests in Container
      # Execute tests inside Docker container
      - name: ğŸ§ª Run Pytest Tests in Docker
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/reports:/app/reports \
            -v ${{ github.workspace }}/logs:/app/logs \
            -v ${{ github.workspace }}/screenshots:/app/screenshots \
            automation-framework:latest \
            pytest -n auto -v --html=reports/test_report.html --self-contained-html
        # Command breakdown:
        # - docker run          â†’ Start container from image
        # - --rm                â†’ Remove container after done (cleanup)
        # - -v ... /reports     â†’ Mount reports dir (get results out!)
        # - -v ... /logs        â†’ Mount logs dir (get logs out!)
        # - -v ... /screenshots â†’ Mount screenshots dir (get images out!)
        # - automation-framework:latest â†’ Use this image
        # - pytest -n auto -v   â†’ Run tests in parallel, verbose
        #
        # ğŸ¯ Why volumes (-v)?
        # Without volumes, results stay inside container (lost!)
        # With volumes, results copied to GitHub workspace (saved!)
        #
        # ğŸ”’ Container isolation:
        # - Tests run in clean environment
        # - No interference from host
        # - Same as production if you deploy with Docker

      # ğŸ­ STEP 5: Run BDD Tests in Container
      # Execute Behave tests inside Docker container
      - name: ğŸ­ Run BDD Tests in Docker
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/reports:/app/reports \
            automation-framework:latest \
            behave -v
        # Same idea as Pytest step, but runs BDD scenarios
        # Uses Gherkin syntax from features/ directory

      # ğŸ“Š STEP 6: Save All Reports
      # Upload everything for download
      - name: ğŸ“Š Upload Test Reports
        if: always()  # ğŸ’¡ Run even if tests fail!
        uses: actions/upload-artifact@v4
        with:
          name: docker-test-reports
          path: |
            reports/
            logs/
            screenshots/
          retention-days: 7
        # What gets saved:
        # - HTML test reports
        # - Execution logs
        # - Failure screenshots
        # 
        # ğŸ’¡ 'if: always()' means:
        #    Upload reports even when tests fail
        #    Super useful for debugging!

      # ğŸ“ STEP 7: Display Summary
      # Show results in GitHub Actions UI
      - name: ğŸ“ Display Test Summary
        if: always()
        run: |
          echo "## ğŸ³ Docker Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Tests completed in Docker container" >> $GITHUB_STEP_SUMMARY
          echo "- Image: automation-framework:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- Runner: ubuntu-latest" >> $GITHUB_STEP_SUMMARY
        # Adds nice summary to GitHub Actions UI
        # Visible at bottom of workflow run page

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # âš¡ JOB 2: Test WITHOUT Docker (for comparison)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test-without-docker:
    runs-on: ubuntu-latest
    
    steps:
      # ğŸ“¥ Get code
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      # ğŸ Setup Python directly (no Docker)
      - name: ğŸ Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: 'pip'  # ğŸš€ Cache pip packages for speed!
        # 'cache: pip' means:
        # - First run: Install all packages (~20s)
        # - Next runs: Use cached packages (~5s)
        # ğŸ’° Saves time and compute!

      # ğŸ“¦ Install packages directly (no Docker)
      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
        # Installs directly on GitHub runner
        # Faster than Docker build!

      # ğŸ§ª Run Pytest directly (no container)
      - name: ğŸ§ª Run Pytest Tests Directly
        run: pytest -n auto -v --html=reports/test_report.html --self-contained-html
        # Runs on runner, not in container
        # Results already in workspace (no volumes needed)

      # ğŸ­ Run Behave directly (no container)
      - name: ğŸ­ Run BDD Tests Directly
        run: behave -v
        # BDD tests on runner, not in container

      # ğŸ“Š Save reports
      - name: ğŸ“Š Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: direct-test-reports
          path: reports/
          retention-days: 7

      # ğŸ“ Summary for direct approach
      - name: ğŸ“ Display Test Summary
        if: always()
        run: |
          echo "## ğŸ’» Direct Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Tests completed directly on runner" >> $GITHUB_STEP_SUMMARY
          echo "- Python: 3.11" >> $GITHUB_STEP_SUMMARY
          echo "- Runner: ubuntu-latest" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ“Š JOB 3: Compare Performance (runs after both complete)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  compare-performance:
    needs: [test-with-docker, test-without-docker]  # â³ Wait for both
    runs-on: ubuntu-latest
    if: always()  # ğŸ’¡ Run even if tests failed
    
    steps:
      # ğŸ“Š Display comparison summary
      - name: ğŸ“Š Performance Summary
        run: |
          echo "## âš¡ Performance Comparison" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ³ Docker Approach" >> $GITHUB_STEP_SUMMARY
          echo "- Build time: ~2-3 minutes (first time)" >> $GITHUB_STEP_SUMMARY
          echo "- Build time: ~30 seconds (cached)" >> $GITHUB_STEP_SUMMARY
          echo "- Test execution: ~30 seconds" >> $GITHUB_STEP_SUMMARY
          echo "- Total: ~2-3 minutes" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Pros: Isolated, consistent, production-like" >> $GITHUB_STEP_SUMMARY
          echo "- âš ï¸  Cons: Slower, more complex" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš¡ Direct Approach" >> $GITHUB_STEP_SUMMARY
          echo "- Setup time: ~30 seconds (cached)" >> $GITHUB_STEP_SUMMARY
          echo "- Test execution: ~30 seconds" >> $GITHUB_STEP_SUMMARY
          echo "- Total: ~1 minute" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Pros: Fast, simple, cheap" >> $GITHUB_STEP_SUMMARY
          echo "- âš ï¸  Cons: Less isolation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ¯ Recommendation" >> $GITHUB_STEP_SUMMARY
          echo "- Daily dev: Use **Direct** approach âš¡" >> $GITHUB_STEP_SUMMARY
          echo "- Production parity: Use **Docker** approach ğŸ³" >> $GITHUB_STEP_SUMMARY
          echo "- Learning: Compare both! ğŸ“" >> $GITHUB_STEP_SUMMARY

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“ LEARNING NOTES:
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# ğŸ³ DOCKER APPROACH:
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 1. Build Image    â†’ 2 min  (installs everything)      â”‚
# â”‚ 2. Run Pytest     â†’ 30 sec (in container)             â”‚
# â”‚ 3. Run Behave     â†’ 20 sec (in container)             â”‚
# â”‚ 4. Upload Results â†’ 5 sec  (save artifacts)           â”‚
# â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
# â”‚ TOTAL:            ~2.5 min                             â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# âš¡ DIRECT APPROACH:
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ 1. Setup Python   â†’ 10 sec (cached)                   â”‚
# â”‚ 2. Install Deps   â†’ 20 sec (cached)                   â”‚
# â”‚ 3. Run Pytest     â†’ 30 sec (on runner)                â”‚
# â”‚ 4. Run Behave     â†’ 20 sec (on runner)                â”‚
# â”‚ 5. Upload Results â†’ 5 sec  (save artifacts)           â”‚
# â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
# â”‚ TOTAL:            ~1.5 min                             â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# ğŸ’¡ KEY DIFFERENCES:
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# Docker:
# âœ… Isolated environment (clean slate)
# âœ… Same as production (if you deploy with Docker)
# âœ… No version conflicts
# âŒ Slower (build image every time)
# âŒ More complex (containers, volumes)
#
# Direct:
# âœ… Faster (no image build)
# âœ… Simpler (standard Python workflow)
# âœ… Better caching (GitHub optimized)
# âŒ Less isolated (shares runner)
# âŒ May differ from production
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ¯ WHEN TO USE EACH:
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# Use Docker when:
# - ğŸš€ Production uses Docker
# - ğŸ‘¥ Large team needs consistency
# - ğŸ“ Learning Docker/containers
# - ğŸ”’ Need strict isolation
#
# Use Direct when:
# - âš¡ Want fast feedback
# - ğŸ’° Minimize cost
# - ğŸ› Easy debugging needed
# - ğŸ‘¤ Small team/solo dev
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ› DEBUGGING TIPS:
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# If Docker tests fail:
# 1. Check "Build Docker Image" step logs
# 2. Look for package installation errors
# 3. Verify Dockerfile syntax
# 4. Test locally: docker build -t test .
#
# If Direct tests fail:
# 1. Check "Run Pytest Tests" step logs
# 2. Look for import errors
# 3. Verify requirements.txt
# 4. Test locally: pytest -v
#
# For both:
# - Download artifacts to see HTML reports
# - Check screenshots/ for visual errors
# - Review logs/ for detailed execution
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“š RESOURCES:
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# - docs/DOCKER_GUIDE.md     â†’ Complete Docker usage guide
# - docs/CI_COMPARISON.md    â†’ Detailed comparison
# - Dockerfile               â†’ See what's in the image
# - .dockerignore            â†’ See what's excluded
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
